<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Shared Playlist - dizzoBX</title>
  <link rel="icon" id="favicon" href="">
  <script>
    // Mobile-safe SVG icons for iOS compatibility
    const _svgPlay = '<svg viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg"><path d="M8 5v14l11-7z" fill="currentColor"/></svg>';
    const _svgPause = '<svg viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg"><rect x="6" y="4" width="4" height="16" fill="currentColor"/><rect x="14" y="4" width="4" height="16" fill="currentColor"/></svg>';
    const _svgPrev = '<svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg"><rect x="4" y="6" width="3" height="12" fill="currentColor"/><path d="M20 6L8 12l12 6V6z" fill="currentColor"/></svg>';
    const _svgNext = '<svg viewBox="0 0 24 24" width="20" height="20" xmlns="http://www.w3.org/2000/svg"><path d="M4 6l12 6L4 18V6z" fill="currentColor"/><rect x="17" y="6" width="3" height="12" fill="currentColor"/></svg>';
    const _svgShuffle = '<svg viewBox="0 0 16 16" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="none"><path fill="currentColor" d="M14.943 1.463a.748.748 0 00-.161-.242l-.002-.001-.001-.002A.748.748 0 0014.25 1h-4a.75.75 0 000 1.5h2.19L1.22 13.72a.75.75 0 101.06 1.06L13.5 3.56v2.19a.75.75 0 001.5 0v-4a.747.747 0 00-.057-.287zM9.5 14.25c0 .414.336.75.75.75h4a.747.747 0 00.75-.75v-4a.75.75 0 00-1.5 0v2.19l-2.47-2.47a.75.75 0 10-1.06 1.06l2.47 2.47h-2.19a.75.75 0 00-.75.75zM6.03 4.97a.75.75 0 01-1.06 1.06L1.22 2.28a.75.75 0 011.06-1.06l3.75 3.75z"/></svg>';
    const _svgVolume = '<svg viewBox="0 0 24 24" width="24" height="24" xmlns="http://www.w3.org/2000/svg" fill="currentColor"><path d="M3 9v6h4l5 5V4L7 9H3zm13.5 3c0-1.77-1.02-3.29-2.5-4.03v8.05c1.48-.73 2.5-2.25 2.5-4.02zM14 3.23v2.06c2.89.86 5 3.54 5 6.71s-2.11 5.85-5 6.71v2.06c4.01-.91 7-4.49 7-8.77s-2.99-7.86-7-8.77z"/></svg>';
  </script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #334bb4 0%, #764ba2 100%);
      height: 100vh;
      color: #fff;
      overflow: hidden;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      padding: 20px;
      height: 100vh;
      display: flex;
      flex-direction: column;
      box-sizing: border-box;
    }

    .player-container {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .player-container > .playlist-header {
      text-align: center;
      margin-bottom: 15px;
      position: relative;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      border-radius: 16px;
      overflow: hidden;
      min-height: 200px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
    }

    .player-container > .playlist-header .playlist-text {
      position: relative;
      z-index: 2;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      color: white;
      text-shadow: 0 2px 4px rgba(0, 0, 0, 0.5);
    }

    .player-container > .playlist-header .playlist-art {
      position: relative;
      z-index: 2;
      width: 120px;
      height: 120px;
      border-radius: 12px;
      margin-bottom: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      background: #333;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 36px;
      overflow: hidden;
    }

    .playlist-art img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .player-container > .playlist-header .playlist-title {
      font-size: 28px;
      font-weight: 700;
      margin: 0;
      text-align: center;
      line-height: 1.2;
    }

    .player-container > .playlist-header .playlist-info {
      font-size: 16px;
      opacity: 0.9;
      margin: 0;
      text-align: center;
      font-weight: 400;
    }

    .player-controls {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 24px;
      margin: 15px 0;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 16px;
      position: relative;
    }

    .control-buttons {
      display: flex;
      align-items: center;
      gap: 20px;
    }

    .control-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 56px;
      height: 56px;
      color: white;
      font-size: 20px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .control-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .control-btn:active {
      transform: scale(0.95);
    }

    .control-btn.active {
      background: rgba(255, 255, 255, 0.4);
      color: #ff6b6b;
    }

    .load-btn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
      z-index: 10;
    }

    .load-btn:hover {
      background: rgba(255, 255, 255, 0.3);
      transform: scale(1.05);
    }

    .load-btn:active {
      transform: scale(0.95);
    }

    .volume-slider {
      position: absolute;
      top: -140px;
      right: 20px;
      width: 40px;
      height: 120px;
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10;
    }

    .volume-slider input[type="range"] {
      -webkit-appearance: none;
      appearance: none;
      width: 100px;
      height: 8px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
      outline: none;
      transform: rotate(-90deg);
      transform-origin: center;
    }

    .volume-slider input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 8px;
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      cursor: pointer;
      backdrop-filter: blur(10px);
    }

    .volume-slider input[type="range"]::-webkit-slider-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      backdrop-filter: blur(10px);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal-content {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 20px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      border: 1px solid rgba(255, 255, 255, 0.2);
    }

    .modal-sm {
      max-width: 300px;
    }

    .modal-content h3 {
      margin-top: 0;
      color: white;
      text-align: center;
    }

    .modal-body {
      margin: 20px 0;
    }

    .upload-section, .restore-section {
      margin-bottom: 15px;
    }

    .upload-section label {
      display: block;
      color: white;
      margin-bottom: 5px;
    }

    .upload-section input[type="file"] {
      width: 100%;
      padding: 8px;
      background: rgba(255, 255, 255, 0.1);
      border: 1px solid rgba(255, 255, 255, 0.2);
      border-radius: 10px;
      color: white;
    }

    .modal-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 10px;
      padding: 10px 15px;
      color: white;
      cursor: pointer;
      transition: all 0.3s ease;
      backdrop-filter: blur(10px);
    }

    .modal-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .modal-footer {
      text-align: center;
    }

    .play-btn {
      width: 72px;
      height: 72px;
      font-size: 24px;
    }

    .progress-container {
      width: 100%;
      max-width: 400px;
    }

    .progress-bar {
      width: 100%;
      height: 6px;
      background: rgba(255, 255, 255, 0.2);
      border-radius: 3px;
      cursor: pointer;
      position: relative;
    }

    .progress-fill {
      height: 100%;
      background: #fff;
      border-radius: 3px;
      width: 0%;
      transition: width 0.1s ease;
    }

    .time-display {
      display: flex;
      justify-content: space-between;
      font-size: 12px;
      margin-top: 8px;
      opacity: 0.8;
    }

    .now-playing {
      text-align: center;
      margin-bottom: 16px;
    }

    .track-title {
      font-size: 18px;
      font-weight: 600;
    }

    .track-artist {
      font-size: 14px;
      opacity: 0.8;
    }

    .playlist-section {
      background: rgba(255, 255, 255, 0.1);
      backdrop-filter: blur(20px);
      border-radius: 16px;
      overflow: hidden;
      max-height: calc(100vh - 380px);
      display: flex;
      flex-direction: column;
      flex: 1;
      min-height: 200px;
    }

    .playlist-header {
      padding: 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      cursor: pointer;
      flex-shrink: 0;
    }

    .playlist-header h3 {
      font-size: 20px;
      font-weight: 600;
    }

    .expand-btn {
      background: none;
      border: none;
      color: white;
      font-size: 18px;
      cursor: pointer;
      transition: transform 0.3s ease;
    }

    .expand-btn.expanded {
      transform: rotate(180deg);
    }

    .playlist-tracks {
      overflow-y: auto;
      transition: max-height 0.3s ease;
      max-height: 0;
      flex: 1;
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.3) rgba(255, 255, 255, 0.05);
    }

    .playlist-tracks.expanded {
      max-height: calc(100vh - 500px);
    }

    .track-item {
      display: flex;
      align-items: center;
      padding: 12px 20px;
      border-bottom: 1px solid rgba(255, 255, 255, 0.1);
      cursor: pointer;
      transition: background 0.2s ease;
    }

    .track-item:hover {
      background: rgba(255, 255, 255, 0.1);
    }

    .track-item.active {
      background: rgba(255, 255, 255, 0.2);
    }

    .track-info {
      flex: 1;
      margin-right: 16px;
    }

    .track-name {
      font-size: 16px;
      font-weight: 500;
      margin-bottom: 2px;
    }

    .track-artist-album {
      font-size: 12px;
      opacity: 0.7;
    }

    /* Custom Scrollbar Styling */
    .playlist-tracks::-webkit-scrollbar {
      width: 8px;
    }

    .playlist-tracks::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 4px;
    }

    .playlist-tracks::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.3);
      border-radius: 4px;
      backdrop-filter: blur(10px);
    }

    .playlist-tracks::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.5);
    }

    .track-play-btn {
      background: rgba(255, 255, 255, 0.2);
      border: none;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      color: white;
      font-size: 16px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s ease;
    }

    .track-play-btn:hover {
      background: rgba(255, 255, 255, 0.3);
    }

    .loading {
      text-align: center;
      padding: 50px;
      font-size: 18px;
    }

    .error {
      text-align: center;
      padding: 50px;
      color: #ff6b6b;
    }

    @media (max-width: 768px) {
      .container {
        padding: 10px;
        height: 100vh;
      }

      .player-container > .playlist-header {
        min-height: 140px !important;
        margin-bottom: 15px;
      }

      .player-container > .playlist-header .playlist-art {
        width: 90px !important;
        height: 90px !important;
        margin-bottom: 8px;
        font-size: 20px;
      }

      .player-container > .playlist-header .playlist-title {
        font-size: 18px;
      }

      .playlist-info {
        font-size: 14px;
      }

      .player-controls {
        padding: 16px;
        margin: 10px 0;
      }

      .control-buttons {
        gap: 12px;
      }

      .control-btn {
        width: 44px;
        height: 44px;
        font-size: 16px;
      }

      .play-btn {
        width: 56px;
        height: 56px;
        font-size: 20px;
      }

      .playlist-section {
        max-height: calc(100vh - 330px);
        min-height: 180px;
      }

      .playlist-tracks.expanded {
        max-height: calc(100vh - 430px);
        min-height: 200px;
      }

      .playlist-header {
        padding: 16px;
      }

      .playlist-header h3 {
        font-size: 18px;
      }

      .track-item {
        padding: 10px 16px;
      }

      .track-name {
        font-size: 14px;
      }

      .track-artist-album {
        font-size: 11px;
      }

      /* Smaller scrollbar on tablets */
      .playlist-tracks::-webkit-scrollbar {
        width: 6px;
      }
    }

    @media (max-width: 480px) {
      .container {
        padding: 8px;
      }

      .player-container > .playlist-header {
        min-height: 120px !important;
        margin-bottom: 15px;
      }

      .player-container > .playlist-header .playlist-art {
        width: 90px !important;
        height: 90px !important;
        margin-bottom: 6px;
        font-size: 18px;
      }

      .player-container > .playlist-header .playlist-title {
        font-size: 16px;
      }

      .player-container > .playlist-header .playlist-info {
        font-size: 12px;
      }

      .player-controls {
        padding: 12px;
        margin: 8px 0;
      }

      .control-buttons {
        gap: 8px;
      }

      .control-btn {
        width: 40px;
        height: 40px;
        font-size: 14px;
      }

      .play-btn {
        width: 48px;
        height: 48px;
        font-size: 18px;
      }

      .playlist-section {
        max-height: calc(100vh - 300px);
        min-height: 150px;
      }

      .playlist-tracks.expanded {
        max-height: calc(100vh - 400px);
        min-height: 180px;
      }

      .playlist-header {
        padding: 12px;
      }

      .playlist-header h3 {
        font-size: 16px;
      }

      .track-item {
        padding: 8px 12px;
      }

      .track-name {
        font-size: 13px;
      }

      .track-artist-album {
        font-size: 10px;
      }

      /* Even smaller scrollbar on mobile */
      .playlist-tracks::-webkit-scrollbar {
        width: 4px;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div id="loading" class="loading">Loading playlist...</div>
    <div id="error" class="error" style="display: none;"></div>
    <div id="player" class="player-container" style="display: none;">
      <div class="playlist-header">
        <button class="load-btn" id="loadBtn" title="Load Playlist">üìÅ</button>
        <div class="playlist-art" id="playlistArt">
          <span>üéµ</span>
        </div>
        <div class="playlist-text">
          <h1 class="playlist-title" id="playlistTitle">Shared Playlist</h1>
          <div class="playlist-info" id="playlistInfo">0 tracks</div>
        </div>
      </div>

      <div class="player-controls">
        <div class="now-playing">
          <div class="track-title" id="currentTrackTitle">-</div>
          <div class="track-artist" id="currentTrackArtist">-</div>
        </div>

        <div class="progress-container">
          <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
          </div>
          <div class="time-display">
            <span id="currentTime">0:00</span>
            <span id="duration">0:00</span>
          </div>
        </div>

        <div class="control-buttons">
          <button class="control-btn" id="prevBtn" title="Previous"></button>
          <button class="control-btn" id="shuffleBtn" title="Shuffle"></button>
          <button class="control-btn play-btn" id="playPauseBtn" title="Play/Pause"></button>
          <button class="control-btn" id="volumeBtn" title="Volume"></button>
          <button class="control-btn" id="nextBtn" title="Next"></button>
        </div>

        <div class="volume-slider" id="volumeSlider" style="display: none;">
          <input type="range" id="volumeControl" min="0" max="1" step="0.01" value="1" orient="vertical">
        </div>
      </div>

      <div class="playlist-section">
        <div class="playlist-header" id="playlistToggle">
          <h3>Playlist</h3>
          <button class="expand-btn expanded" id="expandBtn">‚ñº</button>
        </div>
        <div class="playlist-tracks expanded" id="playlistTracks"></div>
      </div>
    </div>
  </div>

  <audio id="audioPlayer" preload="metadata"></audio>

  <script>

    const defaultPlaylist = 
      {
        "id": 1770226325899,
        "name": "Just Right Tunes",
        "songs": [
          {
            "id": 1844,
            "title": "Down Low Drama",
            "artist": "Christian French",
            "album": "Teenage Times",
            "img": "https://encrypted-tbn0.gstatic.com/images?q=tbn:ANd9GcRdfWwJaX0ESKmPigAU5wVe7gAX-nA7QQlkQA&s",
            "path": "https://dl.espressif.com/dl/audio/gs-16b-1c-44100hz.mp3"
          },
          {
            "id": 2909,
            "title": "Sweet but Psycho still a banger",
            "artist": "Olivia Booles",
            "album": "SOUR",
            "img": "https://crdms.images.consumerreports.org/f_auto,w_600/prod/products/cr/models/404405-wireless-home-studio-style-headphones-jbl-live-660nc-10022266.png",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2949,
            "title": "Scooby Dooby Doo",
            "artist": "William Nelson",
            "album": "Minced Meat",
            "img": "https://images-na.ssl-images-amazon.com/images/I/81aIKP00rlL._AC_UL600_SR600,600_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 3332,
            "title": "Somebody to Love",
            "artist": "Spanish Monkeys",
            "album": "After Hours",
            "img": "https://c8.alamy.com/comp/CRD8YC/funny-cartoon-girl-playing-the-guitar-CRD8YC.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2949,
            "title": "The afternoon Stroll through the park",
            "artist": "William Nelson",
            "album": "Minced Meat",
            "img": "https://images-na.ssl-images-amazon.com/images/I/81aIKP00rlL._AC_UL600_SR600,600_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2212,
            "title": "People are Awesome",
            "artist": "DJ Flavor",
            "album": "Midnight Vibes",
            "img": "https://m.media-amazon.com/images/I/51wFxFndcZL._SL500_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2212,
            "title": "Everybody love a good pizza party!",
            "artist": "DJ Flavor",
            "album": "Midnight Vibes",
            "img": "https://m.media-amazon.com/images/I/51wFxFndcZL._SL500_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2309,
            "title": "Everybodys Calling",
            "artist": "Hannah Banana",
            "album": "Sweet Escape",
            "img": "https://upload.wikimedia.org/wikipedia/en/thumb/8/87/Janet_Jackson_-_Someone_to_call_my_Lover.png/250px-Janet_Jackson_-_Someone_to_call_my_Lover.png",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2949,
            "title": "Thats what I call Jams",
            "artist": "Olivia Booles",
            "album": "SOUR",
            "img": "https://images-na.ssl-images-amazon.com/images/I/81aIKP00rlL._AC_UL600_SR600,600_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 3332,
            "title": "Somebody to Love after all",
            "artist": "Spanish Monkeys",
            "album": "After Hours",
            "img": "https://c8.alamy.com/comp/CRD8YC/funny-cartoon-girl-playing-the-guitar-CRD8YC.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2949,
            "title": "Scooby Dooby Doo",
            "artist": "William Nelson",
            "album": "Minced Meat",
            "img": "https://images-na.ssl-images-amazon.com/images/I/81aIKP00rlL._AC_UL600_SR600,600_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          },
          {
            "id": 2212,
            "title": "People are Awesome",
            "artist": "DJ Flavor",
            "album": "Midnight Vibes",
            "img": "https://m.media-amazon.com/images/I/51wFxFndcZL._SL500_.jpg",
            "path": "https://dl.espressif.com/dl/audio/ff-16b-1c-44100hz.mp3"
          }
        ],
        "shareId": "l07hqhn575l7pa",
        "sharedAt": "2026-02-04T17:32:19.571Z"
      };


    class SharedPlaylistPlayer {
      constructor() {
        this.playlist = null;
        this.currentTrackIndex = 0;
        this.isPlaying = false;
        this.shuffle = false;
        this.volumeSliderTimeout = null;
        this.isManualSelect = false;
        this.audio = document.getElementById('audioPlayer');

        this.init();
        this.initMediaSession();
      }

      initMediaSession() {
        if (!('mediaSession' in navigator)) return;
        try {
          navigator.mediaSession.setActionHandler('play', () => {
            this.play();
          });
          navigator.mediaSession.setActionHandler('pause', () => {
            this.pause();
          });
          navigator.mediaSession.setActionHandler('previoustrack', () => {
            this.prev();
          });
          navigator.mediaSession.setActionHandler('nexttrack', () => {
            this.next();
          });
          navigator.mediaSession.setActionHandler('seekbackward', (details) => {
            const skipTime = details.seekOffset || 10;
            this.audio.currentTime = Math.max(0, this.audio.currentTime - skipTime);
          });
          navigator.mediaSession.setActionHandler('seekforward', (details) => {
            const skipTime = details.seekOffset || 10;
            this.audio.currentTime = Math.min(this.audio.duration || 0, this.audio.currentTime + skipTime);
          });
          navigator.mediaSession.setActionHandler('seekto', (details) => {
            if (details.seekTime !== undefined) {
              this.audio.currentTime = details.seekTime;
            }
          });
          // Initialize metadata
          try {
            navigator.mediaSession.metadata = new window.MediaMetadata({
              title: '',
              artist: '',
              album: '',
              artwork: []
            });
          } catch(e){}
        } catch(e) {
          console.warn('MediaSession init failed', e);
        }
      }

      updateMediaSession() {
        if (!('mediaSession' in navigator)) return;
        const track = this.playlist.songs[this.currentTrackIndex];
        if (!track) return;
        try {
          navigator.mediaSession.metadata = new window.MediaMetadata({
            title: track.title || 'Unknown Title',
            artist: track.artist || 'Unknown Artist',
            album: track.album || 'Unknown Album',
            artwork: track.img ? [{ src: track.img, sizes: '512x512', type: 'image/jpeg' }] : []
          });
          navigator.mediaSession.playbackState = this.isPlaying ? 'playing' : 'paused';
          if ('setPositionState' in navigator.mediaSession && this.audio.duration && !isNaN(this.audio.duration)) {
            navigator.mediaSession.setPositionState({
              duration: this.audio.duration,
              playbackRate: this.audio.playbackRate || 1,
              position: this.audio.currentTime || 0
            });
          }
        } catch(e) {
          console.warn('MediaSession update failed', e);
        }
      }

      init() {
        // Parse URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const shareId = urlParams.get('id');

        if (shareId || (window.location.search && window.location.search !== '?')) {
          const playlist = shareId || window.location.search.slice(1);
          this.loadSharedPlaylist(playlist);
        } else {
          // Load default playlist
          this.playlist = defaultPlaylist;
          this.loadPlaylist();
        }
      }

      async loadSharedPlaylist(shareId) {
        try {
          const response = await fetch(`assets/data/${shareId}.json`);
          if (!response.ok) {
            throw new Error('Playlist not found');
          }
          const data = await response.json();
          this.playlist = data;
          this.loadPlaylist();
        } catch (error) {
          console.error('Failed to load shared playlist:', error);
          this.showError('Failed to load playlist');
        }
      }

      async resolveMissingPaths() {
        const songsNeedingPaths = this.playlist.songs.filter(song => !song.path && song.id);
        
        if (songsNeedingPaths.length === 0) {
          console.log('All songs have paths');
          return;
        }

        console.log(`Resolving paths for ${songsNeedingPaths.length} songs...`);

        // Fetch paths for songs that don't have them
        const fetchPromises = songsNeedingPaths.map(async (song) => {
          try {
            const response = await fetch(`/api/songs/${song.id}`);
            if (response.ok) {
              const fullSongData = await response.json();
              if (fullSongData.path) {
                song.path = fullSongData.path;
                console.log(`Resolved path for "${song.title}": ${song.path}`);
              }
            }
          } catch (error) {
            console.warn(`Failed to resolve path for song ID ${song.id}:`, error);
          }
        });

        await Promise.all(fetchPromises);
        console.log('Path resolution complete');
      }

      async loadPlaylist() {
        if (!this.playlist || !this.playlist.songs || !this.playlist.songs.length) {
          this.showError('Playlist is empty');
          return;
        }

        // Resolve missing paths for songs that don't have them
        await this.resolveMissingPaths();

        // Update UI
        document.getElementById('playlistTitle').textContent = this.playlist.name;
        document.title = this.playlist.name + " | dizzoBX";
        document.getElementById('playlistInfo').textContent = `${this.playlist.songs.length} track${this.playlist.songs.length !== 1 ? 's' : ''}`;

        // Set favicon to 2nd track art if exists, else 1st
        let faviconSrc = '/assets/icon-192.png';
        if (this.playlist.songs && this.playlist.songs.length > 0) {
          if (this.playlist.songs.length > 1 && this.playlist.songs[1].img) {
            faviconSrc = this.playlist.songs[1].img;
          } else if (this.playlist.songs[0].img) {
            faviconSrc = this.playlist.songs[0].img;
          }
        }
        document.getElementById('favicon').href = faviconSrc;

        // Initialize control button icons
        document.getElementById('prevBtn').innerHTML = _svgPrev;
        document.getElementById('shuffleBtn').innerHTML = _svgShuffle;
        document.getElementById('volumeBtn').innerHTML = _svgVolume;
        document.getElementById('nextBtn').innerHTML = _svgNext;

        // Load first track with path
        const firstPlayableIndex = this.playlist.songs.findIndex(song => song.path);
        if (firstPlayableIndex >= 0) {
          this.loadTrack(firstPlayableIndex);
        } else {
          this.showNotification('No playable tracks available in this playlist');
        }

        // Set initial play button state
        document.getElementById('playPauseBtn').innerHTML = _svgPlay;

        // Render playlist tracks
        this.renderTracks();

        // Setup event listeners
        this.setupEventListeners();

        // Show player
        document.getElementById('loading').style.display = 'none';
        document.getElementById('player').style.display = 'block';
      }

      loadTrack(index) {
        if (index < 0 || index >= this.playlist.songs.length) return;

        // Pause current playback before loading new track
        this.audio.pause();
        this.isPlaying = false;

        this.currentTrackIndex = index;
        const track = this.playlist.songs[index];

        // Fix img path by removing '/small' if present
        if (track.img && track.img.endsWith('/small')) {
          track.img = track.img.slice(0, -6);
        }

        console.log('Loading track:', track.title, 'Path:', track.path);

        // Reset play button state
        const playBtn = document.getElementById('playPauseBtn');
        playBtn.disabled = false;
        playBtn.textContent = '‚ñ∂';

        // Set audio source
        if (track.path) {
          // Try the path as-is first (it should be URL-encoded in the database)
          console.log('Setting audio src to:', track.path);
          this.audio.src = track.path;

          // Add a small delay before loading to ensure src is set
          setTimeout(() => {
            this.audio.load();
            console.log('Audio load initiated');
          }, 100);
        } else {
          console.warn('No audio path for track:', track.title);
          this.audio.src = '';
          // Removed showAudioUnavailable for shared playlists to allow playback attempts
        }

        // Update current track display
        document.getElementById('currentTrackTitle').textContent = track.title || 'Unknown Title';
        document.getElementById('currentTrackArtist').textContent = `${track.artist || 'Unknown Artist'} - ${track.album || 'Unknown Album'}`;

        // Update media session
        this.updateMediaSession();

        // Update playlist art (use first track's image or placeholder)
        const artElement = document.getElementById('playlistArt');
        if (track.img) {
          artElement.innerHTML = `<img src="${track.img}" alt="Album art" onerror="this.src='music.ico'">`;
        } else {
          artElement.innerHTML = '<span>üéµ</span>';
        }

        // Update active track in playlist
        this.updateActiveTrack();

        // Reset progress
        this.updateProgress();
      }

      showAudioUnavailable() {
        // For shared playlists, don't disable playback - allow retry
        // Update progress and time displays
        document.getElementById('progressFill').style.width = '0%';
        document.getElementById('currentTime').textContent = '0:00';
        document.getElementById('duration').textContent = '0:00';

        // Show notification
        this.showNotification('Audio playback is not available for shared playlists. This is a preview only.');
      }

      showNotification(message) {
        // Remove existing notification
        const existing = document.querySelector('.notification');
        if (existing) existing.remove();

        // Create new notification
        const notification = document.createElement('div');
        notification.className = 'notification';
        notification.style.cssText = `
          position: fixed;
          top: 20px;
          left: 50%;
          transform: translateX(-50%);
          background: rgba(0, 0, 0, 0.8);
          color: white;
          padding: 12px 20px;
          border-radius: 8px;
          font-size: 14px;
          z-index: 1000;
          backdrop-filter: blur(10px);
        `;
        notification.textContent = message;
        document.body.appendChild(notification);

        // Auto-remove after 5 seconds
        setTimeout(() => {
          if (notification.parentNode) {
            notification.remove();
          }
        }, 5000);
      }

      renderTracks() {
        const tracksContainer = document.getElementById('playlistTracks');
        tracksContainer.innerHTML = '';

        this.playlist.songs.forEach((track, index) => {
          const trackElement = document.createElement('div');
          trackElement.className = `track-item ${index === this.currentTrackIndex ? 'active' : ''}`;
          trackElement.innerHTML = `
            <div class="track-info">
              <div class="track-name">${track.title || 'Unknown Title'}</div>
              <div class="track-artist-album">${track.artist || 'Unknown Artist'}</div>
            </div>
          `;

          // Add click handler
          trackElement.addEventListener('click', () => {
            if (track.path) {
              this.isManualSelect = true;
              this.loadTrack(index);
              // Try to play after a short delay to allow audio to load
              setTimeout(() => {
                if (this.audio.src && !this.isPlaying) {
                  this.play();
                }
              }, 500);
            } else {
              this.showNotification('This track is not available for playback');
            }
          });

          tracksContainer.appendChild(trackElement);
        });
      }

      updateActiveTrack() {
        const trackItems = document.querySelectorAll('.track-item');
        trackItems.forEach((item, index) => {
          item.classList.toggle('active', index === this.currentTrackIndex);
        });

        // Scroll active track into view only when playlist is expanded
        const tracksContainer = document.getElementById('playlistTracks');
        if (tracksContainer.classList.contains('expanded')) {
          const activeTrack = document.querySelector('.track-item.active');
          if (activeTrack) {
            // Calculate positions and scroll manually to prevent container expansion
            const containerRect = tracksContainer.getBoundingClientRect();
            const activeRect = activeTrack.getBoundingClientRect();
            const containerTop = containerRect.top;
            const containerBottom = containerRect.bottom;
            const activeTop = activeRect.top;
            const activeBottom = activeRect.bottom;

            let scrollDelta = 0;
            if (activeTop < containerTop) {
              // Active track is above visible area
              scrollDelta = activeTop - containerTop;
            } else if (activeBottom > containerBottom) {
              // Active track is below visible area
              scrollDelta = activeBottom - containerBottom;
            }

            if (scrollDelta !== 0) {
              tracksContainer.scrollBy({
                top: scrollDelta,
                behavior: 'smooth'
              });
            }
          }
        }
      }

      setupEventListeners() {
        // Audio event listeners
        this.audio.addEventListener('error', (e) => {
          console.error('Audio error:', e);
          console.error('Audio error code:', e.target.error ? e.target.error.code : 'unknown');
          console.error('Audio src:', e.target.src);
          // Show notification only for manual select
          if (this.isManualSelect) {
            this.showNotification('This track is not available for playback');
          }
          // Advance to next track on error only if not manual select
          if (!this.isManualSelect) {
            this.next();
          }
        });

        this.audio.addEventListener('loadstart', () => {
          console.log('Audio load started for:', this.audio.src);
        });

        this.audio.addEventListener('canplay', () => {
          console.log('Audio can play for:', this.audio.src);
        });

        this.audio.addEventListener('loadedmetadata', () => {
          console.log('Audio metadata loaded, duration:', this.audio.duration);
          document.getElementById('duration').textContent = this.formatTime(this.audio.duration);
        });

        this.audio.addEventListener('timeupdate', () => {
          this.updateProgress();
          // Update media session position
          if ('mediaSession' in navigator && 'setPositionState' in navigator.mediaSession && this.audio.duration && !isNaN(this.audio.duration)) {
            navigator.mediaSession.setPositionState({
              duration: this.audio.duration,
              playbackRate: this.audio.playbackRate || 1,
              position: this.audio.currentTime || 0
            });
          }
        });

        this.audio.addEventListener('ended', () => {
          // Auto-advance to next track when current track ends
          this.next();
        });

        this.audio.addEventListener('play', () => {
          this.isPlaying = true;
          document.getElementById('playPauseBtn').innerHTML = _svgPause;
          this.updateActiveTrack();
          if ('mediaSession' in navigator) {
            navigator.mediaSession.playbackState = 'playing';
          }
        });

        this.audio.addEventListener('pause', () => {
          this.isPlaying = false;
          document.getElementById('playPauseBtn').innerHTML = _svgPlay;
          this.updateActiveTrack();
          if ('mediaSession' in navigator) {
            navigator.mediaSession.playbackState = 'paused';
          }
        });

        // Control buttons
        document.getElementById('playPauseBtn').addEventListener('click', () => {
          if (this.isPlaying) {
            this.pause();
          } else {
            this.play();
          }
        });

        document.getElementById('shuffleBtn').addEventListener('click', () => {
          this.toggleShuffle();
        });

        document.getElementById('volumeBtn').addEventListener('click', () => {
          this.toggleVolumeSlider();
        });

        document.getElementById('prevBtn').addEventListener('click', () => {
          this.prev();
        });

        document.getElementById('nextBtn').addEventListener('click', () => {
          this.next();
        });

        document.getElementById('loadBtn').addEventListener('click', () => {
          this.showLoadModal();
        });

        document.getElementById('closeModalBtn').addEventListener('click', () => {
          this.hideLoadModal();
        });

        document.getElementById('restoreDefaultBtn').addEventListener('click', () => {
          this.restoreDefault();
        });

        document.getElementById('playlistFile').addEventListener('change', (e) => {
          this.handleFileUpload(e);
        });

        // Close modal when clicking outside
        document.getElementById('loadModal').addEventListener('click', (e) => {
          if (e.target.id === 'loadModal') {
            this.hideLoadModal();
          }
        });

        // Progress bar
        const progressBar = document.getElementById('progressBar');
        progressBar.addEventListener('click', (e) => {
          const rect = progressBar.getBoundingClientRect();
          const percent = (e.clientX - rect.left) / rect.width;
          this.audio.currentTime = percent * this.audio.duration;
        });

        // Volume control
        const volumeControl = document.getElementById('volumeControl');
        volumeControl.addEventListener('input', (e) => {
          this.audio.volume = e.target.value;
          this.resetVolumeSliderTimeout();
        });

        // Playlist toggle
        const playlistToggle = document.getElementById('playlistToggle');
        const expandBtn = document.getElementById('expandBtn');
        const tracksContainer = document.getElementById('playlistTracks');

        const toggleExpand = () => {
          tracksContainer.classList.toggle('expanded');
          expandBtn.classList.toggle('expanded');
        };

        playlistToggle.addEventListener('click', toggleExpand);
        expandBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleExpand();
        });
      }

      play() {
        if (this.audio.src) {
          console.log('Attempting to play audio:', this.audio.src);
          this.audio.play().catch(e => {
            console.error('Error playing audio:', e);
            // Don't show notification to avoid popups
            // Removed showAudioUnavailable to allow retry
          });
        } else {
          console.warn('No audio source set');
          // Don't show notification
          // Removed showAudioUnavailable to allow retry
        }
      }

      pause() {
        this.audio.pause();
      }

      prev() {
        this.isManualSelect = false;
        // Find previous track with path
        let newIndex = this.currentTrackIndex;
        let attempts = 0;
        do {
          newIndex = newIndex > 0 ? newIndex - 1 : this.playlist.songs.length - 1;
          attempts++;
        } while (!this.playlist.songs[newIndex].path && attempts < this.playlist.songs.length);
        
        if (this.playlist.songs[newIndex].path) {
          this.loadTrack(newIndex);
        } else {
          // No tracks with paths, show message
          this.showNotification('No playable tracks available in this playlist');
        }
        // Try to play after a short delay to allow audio to load
        setTimeout(() => {
          if (this.audio.src && !this.isPlaying) {
            this.play();
          }
        }, 500);
      }

      next() {
        this.isManualSelect = false;
        if (this.shuffle) {
          // Pick a random track with path, avoiding the current one if possible
          const playableTracks = this.playlist.songs.map((song, index) => song.path ? index : -1).filter(index => index >= 0);
          if (playableTracks.length === 0) {
            this.showNotification('No playable tracks available in this playlist');
            return;
          }
          let newIndex;
          if (playableTracks.length > 1) {
            do {
              newIndex = playableTracks[Math.floor(Math.random() * playableTracks.length)];
            } while (newIndex === this.currentTrackIndex && playableTracks.length > 1);
          } else {
            newIndex = playableTracks[0];
          }
          this.loadTrack(newIndex);
        } else {
          // Sequential: find next track with path
          let newIndex = this.currentTrackIndex;
          let attempts = 0;
          do {
            newIndex = newIndex < this.playlist.songs.length - 1 ? newIndex + 1 : 0;
            attempts++;
          } while (!this.playlist.songs[newIndex].path && attempts < this.playlist.songs.length);
          
          if (this.playlist.songs[newIndex].path) {
            this.loadTrack(newIndex);
          } else {
            // No tracks with paths, show message
            this.showNotification('No playable tracks available in this playlist');
          }
        }
        // Try to play after a short delay to allow audio to load
        setTimeout(() => {
          if (this.audio.src && !this.isPlaying) {
            this.play();
          }
        }, 500);
      }

      toggleShuffle() {
        this.shuffle = !this.shuffle;
        const shuffleBtn = document.getElementById('shuffleBtn');
        if (this.shuffle) {
          shuffleBtn.classList.add('active');
        } else {
          shuffleBtn.classList.remove('active');
        }
      }

      toggleVolumeSlider() {
        const slider = document.getElementById('volumeSlider');
        if (slider.style.display === 'none' || slider.style.display === '') {
          slider.style.display = 'flex';
          this.resetVolumeSliderTimeout();
        } else {
          slider.style.display = 'none';
          if (this.volumeSliderTimeout) {
            clearTimeout(this.volumeSliderTimeout);
            this.volumeSliderTimeout = null;
          }
        }
      }

      hideVolumeSlider() {
        const slider = document.getElementById('volumeSlider');
        slider.style.display = 'none';
        if (this.volumeSliderTimeout) {
          clearTimeout(this.volumeSliderTimeout);
          this.volumeSliderTimeout = null;
        }
      }

      resetVolumeSliderTimeout() {
        if (this.volumeSliderTimeout) {
          clearTimeout(this.volumeSliderTimeout);
        }
        this.volumeSliderTimeout = setTimeout(() => {
          this.hideVolumeSlider();
        }, 5000);
      }

      updateProgress() {
        const progressFill = document.getElementById('progressFill');
        const currentTimeEl = document.getElementById('currentTime');
        const durationEl = document.getElementById('duration');

        if (this.audio.duration) {
          const percent = (this.audio.currentTime / this.audio.duration) * 100;
          progressFill.style.width = `${percent}%`;
          currentTimeEl.textContent = this.formatTime(this.audio.currentTime);
          durationEl.textContent = this.formatTime(this.audio.duration);
        }
      }

      formatTime(seconds) {
        if (isNaN(seconds)) return '0:00';
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
      }

      showError(message) {
        document.getElementById('loading').style.display = 'none';
        document.getElementById('error').style.display = 'block';
        document.getElementById('error').textContent = message;
      }

      showLoadModal() {
        document.getElementById('loadModal').style.display = 'flex';
      }

      hideLoadModal() {
        document.getElementById('loadModal').style.display = 'none';
      }

      handleFileUpload(event) {
        const file = event.target.files[0];
        if (!file) return;

        const reader = new FileReader();
        reader.onload = (e) => {
          try {
            const data = JSON.parse(e.target.result);
            // Normalize paths to relative
            if (data.songs) {
              data.songs.forEach(song => {
                if (song.path && song.path.startsWith('/assets/')) {
                  song.path = song.path.replace('/assets/', 'assets/');
                }
                if (song.img && song.img.startsWith('/assets/')) {
                  song.img = song.img.replace('/assets/', 'assets/');
                }
              });
            }
            this.playlist = data;
            this.loadPlaylist();
            this.hideLoadModal();
          } catch (error) {
            alert('Invalid JSON file');
          }
        };
        reader.readAsText(file);
      }

      restoreDefault() {
        this.loadSharedPlaylist('mytunes');
        this.hideLoadModal();
      }
    }

    // Initialize when DOM is loaded
    document.addEventListener('DOMContentLoaded', () => {
      new SharedPlaylistPlayer();
    });
  </script>

  <!-- Load Playlist Modal -->
  <div id="loadModal" class="modal" style="display: none;">
    <div class="modal-content modal-sm">
      <h3>Load Playlist</h3>
      <div class="modal-body">
        <div class="upload-section">
          <label for="playlistFile">Upload JSON Playlist:</label>
          <input type="file" id="playlistFile" accept=".json">
        </div>
        <div class="restore-section">
          <button id="restoreDefaultBtn" class="modal-btn">Restore Default Playlist</button>
        </div>
      </div>
      <div class="modal-footer">
        <button id="closeModalBtn" class="modal-btn">Close</button>
      </div>
    </div>
  </div>
</body>
</html>